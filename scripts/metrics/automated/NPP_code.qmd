---
title: "Metric Analysis Code"
format: html
execute: 
  echo: true
  warning: false
editor: 
  markdown: 
    wrap: sentence
---

File created on 2026-02-06 by Carissa Gervasi

# 0. Setup

Add any packages that are needed for analysis in this code chunk.

```{r packages}
library(IEAnalyzeR)
library(here)
library(ggplot2)
library(maps)
```

File Naming Setup.
!! Auto generated-Do Not Change !!

```{r}

root_name<- "NPP"

csv_filename<-here(paste0("data/formatted/formatted_csvs/", root_name, "_formatted.csv")) 
object_filename<-here(paste0("data/formatted/final_objects/", root_name, "_object.rds"))
plot_filename<-here(paste0("figures/plots/", root_name, "_plot.png"))

```

# 1. Read Data

Pull data from its source: Manual data: data/unformatted data. Automated data: Add script for data call (API, package, etc.). Confidential data: Store locally in the confidential data folder - This folder is excluded using gitignore and will not push to the GitHub repo. If intermediate data (shapefiles etc.) are needed, please put them in data\>intermediate - Filename should use the syntax rootname_descriptivename

```{r}
load("indicator_processing/spec_file.RData")


# download data ------------------------------------------------

#This format works. Might also want to consider rerddap package...
url <- paste0("https://coastwatch.pfeg.noaa.gov/erddap/griddap/pmlEsaCCI60OceanColorMonthly.csv?chlor_a", "[(2002-06-01T09:00:00Z)][(-89.99):1000:(89.99)][(-179.99):1000:(180.0)]")

#This format is the right lat and long but does not work. Need to do slight syntax fix
url <- paste0("https://coastwatch.pfeg.noaa.gov/erddap/griddap/pmlEsaCCI60OceanColorMonthly_Lon0360.csv?chlor_a", 
              "[(1997-12-01T00:00:00Z):1:(", 2025, "-12-01T00:00:00Z)][(", 
              31, "):1:(", 18, ")][(", 360 + -98, "):1:(", 360 + -80, ")]")
url

url <- paste0("https://coastwatch.pfeg.noaa.gov/erddap/griddap/pmlEsaCCI60OceanColorMonthly_Lon0360.csv?chlor_a", 
              "[(1997-12-01T00:00:00Z):1:(", terminal_year, "-12-01T00:00:00Z)][(", 
              max_lat, "):1:(", min_lat, ")][(", 360 + min_lon, "):1:(", 360 + max_lon, ")]")
url
              
# old data source: "https://coastwatch.pfeg.noaa.gov/erddap/griddap/erdMH1chlamday.csv?chlorophyll[(2003-01-16T00:00:00Z):1:(2021-12-16T00:00:00Z)][(18.5):1:(17.5)][(-67.4):1:(-64.4)]"

options(download.file.method="libcurl")

download.file(url = url, destfile = here("data/intermediate/NPP.csv"))
  
labs <- read.table("chl.csv", sep = ",", header = T, skip = 0)
chl <- read.table("chl.csv", sep = ",", header = T, skip = 1)
names(chl) <- names(labs)
head(chl)

file.remove("chl.csv")
```

# 2. Clean data and create time series csv

Transform the data to fit the IEA data format.
For more info on IEA data format go to the IEAnalyzeR vignette [HERE](https://gulf-iea.github.io/IEAnalyzeR/articles/How_to_use_IEAnalyzeR.html).
Once data are formatted with time (annual or monthly) as column 1 and metric values in the remaining columns, you can use the function convert_cleaned_data to convert your csv into a format that can be read by the data_prep function. Replace "your_data" in the code below with whatever your dataframe is called.

```{r}
#Define header components for the data rows (ignore year). Fill in the blanks here.
indicator_names = c("")
unit_names = c("")
extent_names = c("")

formatted_data = IEAnalyzeR::convert_cleaned_data(your_data, indicator_names, unit_names, extent_names)
```

# 3. Save Formatted data as csv

This will save your data to the appropriate folder.
```{r}
write.csv(formatted_data, file = csv_filename, row.names = F)
```


# 4. Create Data_Prep object

Please use your formatted csv to create a "data_prep" object.
For more info on the data_prep function see the vignette linked above.
```{r}
data_obj<-IEAnalyzeR::data_prep(csv_filename)
```

# 5. Save Formatted data_prep object

This will save your data to the appropriate folder.
```{r}
saveRDS(data_obj, file = object_filename)
```

# 6. Preview Plot

Use the IEAnalyzeR plotting function to preview the data.
This will not necessarily be the final figure used in reports.
For more info on the plot_fn_obj function go HERE

```{r}
IEAnalyzeR::plot_fn_obj(df_obj = data_obj, trend = TRUE)
```

# 7. Save plot

This will save the plot to the correct folder.
Adjust height & width using (height=, width=, unit="in") if needed.

```{r}
ggsave(filename = plot_filename)
```
